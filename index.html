<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Okta Copilot Sample SPA</title>

  <!-- Okta Auth JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@okta/okta-auth-js@7.14.1/dist/okta-auth-js.umd.min.js"></script>

  <!-- Optional: Okta Sign-In Widget CSS -->
  <link rel="stylesheet" href="https://global.oktacdn.com/okta-signin-widget/7.37.1/css/okta-sign-in.min.css" />
  <script src="https://global.oktacdn.com/okta-signin-widget/7.37.1/js/okta-sign-in.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    #user-info { display: none; }
  </style>
</head>
<body>
  <div id="login-container"></div>

  <div id="user-info">
    <h2>Welcome, <span id="user-name"></span></h2>
    <button id="logout">Sign Out</button>
  </div>

  <script>
    window.onload = async () => {
      // ---------- Configuration ----------
      const oktaDomain = "trial-2737234.okta.com";
      const clientId = "0oaxwn8ufgFda5Dfq697";
      const redirectUri = window.location.origin + window.location.pathname; // must match Okta SPA redirect URI exactly
      const issuer = `https://${oktaDomain}/oauth2/default`;
      const scopes = ["openid", "profile", "email"];

      // ---------- Initialize OktaAuth ----------
      const authClient = new OktaAuth.default({
        issuer,
        clientId,
        redirectUri,
        pkce: true,
        scopes
      });

      // ---------- Handle redirect callback ----------
      async function handleRedirectCallback() {
        try {
          const tokens = await authClient.token.parseFromUrl();
          authClient.tokenManager.setTokens(tokens);
          showUserInfo();
        } catch (err) {
          // Not a redirect callback, ignore
        }
      }

      // ---------- Show login widget ----------
      function showLoginWidget() {
        const widget = new OktaSignIn({
          baseUrl: `https://${oktaDomain}`,
          clientId: clientId,
          redirectUri: redirectUri,
          authParams: {
            issuer: issuer,
            pkce: true,
            scopes: scopes
          }
        });

        widget.renderEl(
          { el: '#login-container' },
          () => { /* success callback will redirect */ },
          (err) => console.error("Widget error", err)
        );
      }

      // ---------- Display user info ----------
      async function showUserInfo() {
        document.getElementById("login-container").style.display = "none";
        document.getElementById("user-info").style.display = "block";

        try {
          const user = await authClient.getUser();
          document.getElementById("user-name").textContent = user.name || user.email || user.sub;
        } catch (err) {
          console.error("Failed to get user info:", err);
        }
      }

      // ---------- Logout ----------
      async function logout() {
        await authClient.signOut();
        document.getElementById("login-container").style.display = "block";
        document.getElementById("user-info").style.display = "none";
      }

      document.getElementById("logout").onclick = logout;

      // ---------- Main flow ----------
      await handleRedirectCallback();

      const authenticated = await authClient.isAuthenticated();
      if (!authenticated) {
        showLoginWidget();
      } else {
        showUserInfo();
      }
    };
  </script>
</body>
</html>
