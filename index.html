<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Okta Copilot Sample SPA</title>
  <!-- Load Okta Sign‑In Widget CSS if you need hosted widget styling -->
  <link rel="stylesheet" href="https://global.oktacdn.com/okta-signin-widget/7.37.1/css/okta-sign-in.min.css" />
  <script src="https://global.oktacdn.com/okta-signin-widget/7.37.1/js/okta-sign-in.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@okta/okta-auth-js@7.14.1/dist/okta-auth-js.umd.min.js"></script>
</head>
<body>
  <div id="login-container"></div>
  <div id="user-info" style="display: none;">
    <h2>Welcome, <span id="user-name"></span></h2>
    <button id="logout">Sign out</button>
  </div>

  <script>
    // Configuration
    const oktaDomain = "trial-2737234.okta.com";
    const clientId = "0oaxwn8ufgFda5Dfq697";
    const redirectUri = window.location.origin + window.location.pathname; // ensure exact match with Okta redirect URI
    const issuer = `https://${oktaDomain}/oauth2/default`;

    const authClient = new OktaAuth({   // OktaAuth from okta-auth-js
      issuer,
      clientId,
      redirectUri,
      pkce: true,
      scopes: ["openid", "profile", "email"],
    });

    // On page load — check if returning from Okta with code
    async function handleCallback() {
      try {
        const tokens = await authClient.token.parseFromUrl();
        authClient.tokenManager.setTokens(tokens);
        showUserInfo();
      } catch (err) {
        // Not a callback or no code — ignore
      }
    }

    function showLogin() {
      // Option A: Use Sign-In Widget
      const widget = new OktaSignIn({
        baseUrl: `https://${oktaDomain}`,
        clientId: clientId,
        redirectUri: redirectUri,
        authParams: {
          issuer: issuer,
          pkce: true,
          scopes: ["openid", "profile", "email"]
        }
      });
      widget.renderEl(
        { el: '#login-container' },
        () => { /* success — should redirect */ },
        (err) => console.error(err)
      );
    }

    async function showUserInfo() {
      document.getElementById("login-container").style.display = "none";
      document.getElementById("user-info").style.display = "block";
      try {
        const user = await authClient.getUser();
        document.getElementById("user-name").textContent = user.name || user.email || user.sub;
      } catch (e) {
        console.error("Failed to get user info", e);
      }
    }

    async function logout() {
      await authClient.signOut();
    }

    document.getElementById("logout").onclick = logout;

    // Main flow
    window.onload = async () => {
      await handleCallback();
      const authenticated = await authClient.isAuthenticated();
      if (!authenticated) {
        showLogin();
      } else {
        showUserInfo();
      }
    };
  </script>
</body>
</html>
