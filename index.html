<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Okta Copilot Sample SPA</title>

  <!-- Okta Auth JS -->
  <script src="https://global.oktacdn.com/okta-auth-js/7.14.1/okta-auth-js.min.js"></script>

  <!-- Okta Sign-In Widget CSS & JS -->
  <link rel="stylesheet" href="https://global.oktacdn.com/okta-signin-widget/7.37.1/css/okta-sign-in.min.css" />
  <script src="https://global.oktacdn.com/okta-signin-widget/7.37.1/js/okta-sign-in.min.js"></script>

  <!-- Favicon placeholder to avoid 404 -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    #user-info { display: none; }
  </style>
</head>
<body>
  <div id="login-container"></div>

  <div id="user-info">
    <h2>Welcome, <span id="user-name"></span></h2>
    <button id="logout">Sign Out</button>
  </div>

  <script>
    window.onload = async () => {
      // ---------- Configuration ----------
      const oktaDomain = "trial-2737234.okta.com";
      const clientId = "0oaxwn8ufgFda5Dfq697";
      const redirectUri = "https://okta-copilot-sample.onrender.com/index.html";
      const issuer = `https://${oktaDomain}/oauth2/default`;
      const scopes = ["openid", "profile", "email"];
      const postLogoutRedirectUri = "https://okta-copilot-sample.onrender.com/signout.html";

      // ---------- Initialize OktaAuth ----------
      const authClient = new OktaAuth({
        issuer,
        clientId,
        redirectUri,
        pkce: true,
        scopes
      });

      // ---------- Handle redirect callback ----------
      async function handleRedirectCallback() {
        try {
          const tokenResponse = await authClient.token.parseFromUrl();
          if (tokenResponse.tokens) {
            authClient.tokenManager.setTokens(tokenResponse.tokens);
          }
        } catch (err) {
          // Not a redirect callback, ignore
        }
      }

      // ---------- Display user info ----------
      async function showUserInfo() {
        try {
          // Only call getUser if idToken exists
          const idToken = await authClient.tokenManager.get("idToken");
          if (!idToken) {
            console.warn("No valid token found. User might not be logged in.");
            return;
          }
          const user = await authClient.getUser();
          document.getElementById("user-name").textContent = user.name || user.email || user.preferred_username;
          document.getElementById("login-container").style.display = "none";
          document.getElementById("user-info").style.display = "block";
        } catch (err) {
          console.error("Failed to get user info:", err);
        }
      }

      // ---------- Logout ----------
      async function logout() {
        await authClient.signOut({ postLogoutRedirectUri });
      }
      document.getElementById("logout").onclick = logout;

      // ---------- Main flow ----------
      await handleRedirectCallback();

      const authenticated = await authClient.isAuthenticated();
      if (authenticated) {
        await showUserInfo();
      } else {
        // ---------- Show login widget ----------
        const widget = new OktaSignIn({
          baseUrl: `https://${oktaDomain}`,
          clientId: clientId,
          redirectUri: redirectUri,
          authParams: {
            issuer,
            pkce: true,
            scopes
          }
        });

        widget.renderEl(
          { el: '#login-container' },
          () => { /* login success will redirect */ },
          (err) => console.error("Widget error:", err)
        );
      }
    };
  </script>
</body>
</html>
